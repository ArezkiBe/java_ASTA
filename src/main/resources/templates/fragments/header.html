<!-- header fragment -->
<div th:fragment="header" xmlns:th="http://www.thymeleaf.org">
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/}">ALTN72 - TP Fil Rouge</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <!-- Affiche le username s'il est présent dans le modèle (currentUsername) -->
                    <li class="nav-item" th:if="${currentUsername != null}">
                        <span class="nav-link">Bonjour <span th:text="${currentUsername}">Utilisateur</span> |</span>
                    </li>

                    <!-- Logout via POST pour respecter CSRF -- affiché si user connecté -->
                    <li class="nav-item" th:if="${currentUsername != null}">
                        <form th:action="@{/perform_logout}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="nav-link btn btn-link" style="padding:0;">Déconnectez-vous</button>
                        </form>
                    </li>

                    <!-- Lien de connexion affiché si aucune session utilisateur -->
                    <li class="nav-item" th:if="${currentUsername == null}">
                        <a class="nav-link" th:href="@{/login}">Se connecter</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Script pour vérifier la session côté client uniquement si utilisateur connecté -->
    <script th:if="${currentUsername != null}">
        (function() {
            const checkSession = () => {
                fetch('/session/check', { credentials: 'same-origin' })
                    .then(resp => {
                        if (resp.status === 401) {
                            // session invalide → redirection vers login
                            window.location.href = '/login?expired=true';
                        }
                    })
                    .catch(err => {
                        console.error('Session check failed', err);
                    });
            };

            // check on load
            checkSession();
            // check every 60 seconds
            setInterval(checkSession, 60000);
        })();
    </script>
</div>
