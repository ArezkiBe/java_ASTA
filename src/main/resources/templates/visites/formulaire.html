<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${modeCreation ? 'Planifier Visite - ASTA' : 'Modifier Visite - ASTA'}">Visite - ASTA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/app.css}" rel="stylesheet">
</head>
<body class="bg-light">

    <!-- Navigation unifiée -->
    <div th:replace="~{fragments/header :: navbar('visites')}"></div>

    <div class="container-fluid mt-4">
        
        <!-- Fil d'Ariane -->
        <div th:replace="~{fragments/breadcrumb :: visites(${modeCreation ? 'Planifier Visite' : 'Modifier Visite'})}"></div>

        <!-- Messages flash -->
        <div th:replace="~{fragments/messages :: all}"></div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            <span th:text="${modeCreation ? 'Planifier une Nouvelle Visite' : 'Modifier la Visite'}">Formulaire Visite</span>
                        </h5>
                    </div>
                    
                    <div class="card-body">
                        <form th:action="${modeCreation ? '/web/visites' : '/web/visites/' + visite.id}" 
                              method="post" 
                              th:object="${visite}" 
                              class="needs-validation" 
                              novalidate>
                            
                            <div class="row">
                                <!-- Date de la visite -->
                                <div class="col-md-6 mb-3">
                                    <label for="date" class="form-label">
                                        Date de la Visite <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="date" 
                                           th:field="*{date}" 
                                           required>
                                    <div class="invalid-feedback">
                                        Veuillez sélectionner une date pour la visite.
                                    </div>
                                </div>

                                <!-- Format de la visite -->
                                <div class="col-md-6 mb-3">
                                    <label for="format" class="form-label">
                                        Format de la Visite <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" 
                                            id="format" 
                                            th:field="*{format}" 
                                            required>
                                        <option value="">-- Sélectionner le format --</option>
                                        <option value="Présentiel">Présentiel (sur site)</option>
                                        <option value="Visio">Visioconférence</option>
                                        <option value="Téléphonique">Entretien téléphonique</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Veuillez sélectionner un format de visite.
                                    </div>
                                </div>
                            </div>

                            <!-- Apprenti concerné -->
                            <div class="mb-3">
                                <label for="apprenti" class="form-label">
                                    Apprenti Concerné <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" 
                                        id="apprenti" 
                                        th:field="*{apprenti}" 
                                        required>
                                    <option value="">-- Sélectionner un apprenti --</option>
                                    <option th:each="apprenti : ${apprentis}" 
                                            th:value="${apprenti.id}" 
                                            th:text="${apprenti.nomComplet + ' (' + apprenti.programme + ')'}"
                                            th:selected="${visite.apprenti != null and visite.apprenti.id == apprenti.id}">
                                        Nom Apprenti
                                    </option>
                                </select>
                                <div class="invalid-feedback">
                                    Veuillez sélectionner un apprenti.
                                </div>
                            </div>

                            <!-- Statut -->
                            <div class="mb-3">
                                <label for="statut" class="form-label">
                                    Statut de la Visite <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" 
                                        id="statut" 
                                        th:field="*{statut}" 
                                        required>
                                    <option value="">-- Sélectionner le statut --</option>
                                    <option value="Programmée">Programmée</option>
                                    <option value="Réalisée">Réalisée</option>
                                    <option value="Annulée">Annulée</option>
                                    <option value="Reportée">Reportée</option>
                                </select>
                                <div class="invalid-feedback">
                                    Veuillez sélectionner un statut.
                                </div>
                            </div>

                            <!-- Commentaires généraux -->
                            <div class="mb-3">
                                <label for="commentaires" class="form-label">
                                    Commentaires et Objectifs
                                </label>
                                <textarea class="form-control" 
                                          id="commentaires" 
                                          th:field="*{commentaires}" 
                                          rows="3"
                                          placeholder="Objectifs de la visite, points à aborder, observations..."></textarea>
                                <div class="form-text">Décrivez les objectifs ou observations de cette visite</div>
                            </div>

                            <!-- Commentaires du tuteur -->
                            <div class="mb-4">
                                <label for="commentaireTuteur" class="form-label">
                                    Commentaires du Tuteur Enseignant
                                </label>
                                <textarea class="form-control" 
                                          id="commentaireTuteur" 
                                          th:field="*{commentaireTuteur}" 
                                          rows="3"
                                          placeholder="Retour du tuteur enseignant après la visite..."></textarea>
                                <div class="form-text">À remplir après la visite (facultatif)</div>
                            </div>

                            <!-- Boutons d'action -->
                            <div class="d-flex justify-content-between">
                                <a th:href="@{/web/visites}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left me-2"></i>Retour à la liste
                                </a>
                                
                                <div>
                                    <button type="button" 
                                            class="btn btn-outline-secondary me-2" 
                                            onclick="resetForm()">
                                        <i class="fas fa-undo me-2"></i>Réinitialiser
                                    </button>
                                    <button type="submit" 
                                            class="btn btn-primary">
                                        <i th:class="${modeCreation ? 'fas fa-calendar-plus' : 'fas fa-check'} + ' me-2'"></i>
                                        <span th:text="${modeCreation ? 'Planifier la Visite' : 'Mettre à Jour'}">Enregistrer</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Aide contextuelle -->
                <div class="card mt-3" th:if="${modeCreation}">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Guide de Planification
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Types de visite :</h6>
                                <ul class="small">
                                    <li><strong>Présentiel :</strong> Visite sur le lieu de travail</li>
                                    <li><strong>Visioconférence :</strong> Entretien à distance</li>
                                    <li><strong>Téléphonique :</strong> Suivi par téléphone</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Points à aborder :</h6>
                                <ul class="small">
                                    <li>Intégration et adaptation</li>
                                    <li>Missions et responsabilités</li>
                                    <li>Compétences développées</li>
                                    <li>Difficultés rencontrées</li>
                                    <li>Évolution du projet</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Scripts de validation et fonctionnalités -->
    <script>
        // Validation Bootstrap
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // Fonction pour réinitialiser le formulaire
        function resetForm() {
            if (confirm('Êtes-vous sûr de vouloir réinitialiser le formulaire ?')) {
                document.querySelector('form').reset();
                document.querySelector('form').classList.remove('was-validated');
            }
        }

        // Validation de la date (ne peut pas être dans le passé pour une nouvelle visite)
        document.getElementById('date').addEventListener('change', function() {
            const selectedDate = new Date(this.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate < today && document.querySelector('form').action.includes('nouveau')) {
                if (confirm('Vous avez sélectionné une date dans le passé. Voulez-vous continuer ?')) {
                    // L'utilisateur confirme, on garde la date
                } else {
                    this.value = ''; // Réinitialiser la date
                }
            }
        });

        // Auto-fill de suggestions selon le format choisi
        document.getElementById('format').addEventListener('change', function() {
            const commentairesField = document.getElementById('commentaires');
            const format = this.value;
            
            if (format === 'Présentiel' && commentairesField.value === '') {
                commentairesField.value = 'Visite sur site - Points à aborder : intégration, missions, environnement de travail';
            } else if (format === 'Visio' && commentairesField.value === '') {
                commentairesField.value = 'Entretien en visioconférence - Suivi projet et difficultés éventuelles';
            } else if (format === 'Téléphonique' && commentairesField.value === '') {
                commentairesField.value = 'Entretien téléphonique - Point rapide sur l\'avancement';
            }
        });
    </script>
</body>
</html>